<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Airflow - Backfill Utility</title>
    <link rel="icon" type="image/png" href="/static/pin_30.png">

    <!-- bootstrap 4 deps-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


    <!-- datepicker deps for bootstrap 4-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/js/tempusdominus-bootstrap-4.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/css/tempusdominus-bootstrap-4.min.css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">



    <script>
    $(document).ready(function(){

        var source = null;

        var backfill_success_message = '<div class="alert alert-success alert-dismissible">'+
                                       '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'+
                                       '<strong>&#128077;</strong> Backfill has been completed successfully'+
                                       '</div>';
        var cleared_success_message = '<div class="alert alert-success alert-dismissible">'+
                                       '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'+
                                       '<strong>&#128077;</strong> Dag runs have been cleared successfully'+
                                       '</div>';
        var backfill_error_message = '<div class="alert alert-danger alert-dismissible fade show">'+
                                     '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'+
                                     '<strong>&#128078;</strong> Something went wrong !'+
                                     '</div>';

        var background_success_message = '<div class="alert alert-success alert-dismissible">'+
                                       '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'+
                                       '<strong>&#128077;</strong> Background job submitted'+
                                       '</div>';
        var stream_stopped_message = '<div class="alert alert-info alert-dismissible">'+
                                        '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'+
                                        '<strong>&#128517;</strong> Streaming has been stopped'+
                                      '</div>'

        var spinner_backfill_message = '<span class="spinner-border text-primary" style="height: 20px; width:20px;"></span>&nbsp;&nbsp;<strong>Executing </strong><span id="stop_process" style="margin-left:10px; color:blue; text-decoration: underline; cursor: pointer;">Stop Streaming</span>'

        var spinner_background_message = '<span class="spinner-border text-primary" style="height: 20px; width:20px;"></span>&nbsp;&nbsp;<strong>Submitting background task</strong>'

        var backfill_done = function(){
            $("#backfill_status").html(backfill_success_message)
        };
        var backfill_err = function(){
            $("#backfill_status").html(backfill_error_message)
        };
        var backfill_progress = function(){
            $("#backfill_status").html(spinner_backfill_message)
        }
        var clear_done = function(){
            $("#backfill_status").html(cleared_success_message)
        }

        var background_progress = function(){
            $("#backfill_status").html(spinner_background_message)
        }
        var background_done = function(){
            $("#backfill_status").html(background_success_message)
        }

        var disable_form = function(){
            $("#form :input").prop("disabled", true);
        }

        var enable_form = function(){
            $("#form :input").prop("disabled", false);
        }

        var stream_stopped = function(){
            $("#backfill_status").html(stream_stopped_message)
        }

        $("#form").submit(function(event){            

            event.preventDefault();

            var dag_name = $("#dag_name").val();
            var start_date = moment($("#start_date").val()).format('YYYY-MM-DDTHH:mm:00');
            var end_date = moment($("#end_date").val()).format('YYYY-MM-DDTHH:mm:00');

            var background = $("#background").prop("checked");
            var clear_prev = $("#clear_prev").prop("checked");

            var query_string = "?dag_name=" + dag_name +
                               "&start_date=" + start_date +
                               "&end_date=" + end_date +
                               "&clear="+clear_prev;

            var st_date = moment($("#start_date").val())
            var en_date = moment($("#end_date").val())

            if(st_date > en_date){        
                alert('Start date should be less than end date ')
                return false;
            }
            if(en_date > st_date && en_date.diff(st_date, 'days') > 7){
                alert('Difference between start and end date should not exceed 7 days')
                return false;
            }

            // disable the form
            disable_form()


            if(background==false){
                
                url = '/admin/backfill/stream'+query_string;

                document.getElementById("output").innerHTML = '';

                // start streaming
                source = new EventSource(url);

                // show spinner for backfill in progress
                var show_spinner = 0;

                source.onmessage = function(event) {

                    // show spinner
                    if(show_spinner == 0){
                        backfill_progress()
                        show_spinner = 1;
                    }

                    if (event.data.indexOf('Backfill done. Exiting.') != -1){
                        $("#output").prepend(event.data+"<br>")
                        source.close()
                        backfill_done()
                        enable_form()
                    }
                    else if(event.data.indexOf('dag_id could not be found') >= 0){
                        $("#output").prepend(event.data+"<br>")
                        source.close()
                        backfill_err()
                        enable_form()
                    }
                    else if(event.data.indexOf('Clear Done') >= 0){
                        $("#output").prepend(event.data+"<br>")
                        source.close()
                        clear_done()
                        enable_form()
                    }
                    else if(event.data.indexOf('Nothing to clear') >= 0){
                        $("#output").prepend(event.data+"<br>")
                        source.close()
                        clear_done()
                        enable_form()
                    }
                    else{
                        $("#output").prepend(event.data+"<br>")
                    } 
                }
            }
            else {
                user_accepted = confirm("You have selected background backfill for DAG name '"+dag_name+"'. Please click OK if DAG name is correct.")

                if (user_accepted == true){
                    url = '/admin/backfill/background'+query_string

                    // show background progress message
                    background_progress()

                    $.get(url, function(data){

                        document.getElementById("output").innerHTML = '<center>Your background job has been submitted successfully !</center>'

                        // show background submission task message
                        background_done()

                        // enable the form
                        enable_form()

                    })
                }else{
                    // enable the form 
                    enable_form()
                }
                


            }            

        });



        $("#history_load").click(function(){

            $("#history").html('Fetching history...')

            $.get('/admin/backfill/history', function(data){

                if(data != null){
                    data_rows = data.split('\n')
                    
                    var rows = [];

                    for(var x=0; x < data_rows.length - 1; x++){
                        row = data_rows[x].split(',')

                        var time = moment(row[1]).format('YYYY-MM-DD HH:mm:SS')
                        var r = '<div style="margin-top: 10px; border-bottom: 1px solid #f1f1f1; padding-bottom: 10px;">'+row[0]+'<span class="far fa-clock" style="float:right; font-size: 12px; color: #565656;">&nbsp;&nbsp;'+time+'</span>'+'</div>'

                        rows.push(r)

                    }

                    var rev_array = rows.reverse().join('')

                    $("#history").html(rev_array)
                }else{
                    $("#history").html('Something went wrong!')
                }
                
            }) 

        })
        

        // UPDATING SCROLL OF OUTPUT
        // function updateScroll(){
        //     var element = document.getElementById("output");
        //     element.scrollTop = element.scrollHeight;
        // }

        // var scroll_interval = setInterval(updateScroll,200);
        // $( "#output" ).scroll(function(){
        //     if (scroll_interval != null || scroll_interval != undefined ){
        //         console.log('Scrolled called. Stopping auto scroll')
        //         clearInterval(scroll_interval)
        //     }
            
        // })
            

        $(document).on('click','#stop_process',function(){
            if(source != undefined || source != null){
                source.close();
                stream_stopped();
                source = null;
                
                // enable the form
                enable_form()
            }
        });


        /*For Smooth UX*/

        // keep an eye on checkboxes
        $('#backfill').change(function() {
            if($(this).prop("checked") == true){
                $('#clear_prev').prop('checked', false);
            }else{
                $('#clear_prev').prop('checked', true);
            }
        });
        $('#clear_prev').change(function() {
            if($(this).prop("checked") == true){
                $('#backfill').prop('checked', false);
            }else{
                $('#backfill').prop('checked', true);
            } 
        });

        // toottip
        $('[data-toggle="tooltip"]').tooltip(); 

        // max and min date controls
        var max_date = new Date();
        var min_date = new Date(moment(max_date).subtract(365 , 'day'));
        $('#start_date').datetimepicker({
            maxDate: max_date,
            minDate: min_date,
            icons: {
                time: 'far fa-clock',
                date: 'far fa-calendar',
                today: 'far fa-calendar-check-o',
                clear: 'far fa-trash',
                close: 'far fa-times'
            }
        });
        $('#end_date').datetimepicker({
            maxDate: max_date,
            minDate: min_date,
            icons: {
                time: 'far fa-clock',
                date: 'far fa-calendar',
                today: 'far fa-calendar-check-o',
                clear: 'far fa-trash',
                close: 'far fa-times'
            }
        });
        $('#end_date').val('')
        $('#start_date').val('')
        
    });

    
    </script>

    <style>

        /*Custom size for jumbotron*/
        .custom-jumbotron{
            height: 100px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .row{
            margin-bottom: 10px;
        }

        .info-icon{
            font-weight: bolder;
        }

        #output{
            padding: 5px;
            background: #f7f7f7;
            height: 350px;
            overflow-y: scroll;
        }

    </style>
</head>
<body>
    <div class="custom-jumbotron jumbotron jumbotron-fluid">
        <div class="container">
            <h1><img src="https://airflow.apache.org/_images/pin_large.png" width="40" height="40">
            Airflow Backfill Utility</h1>      
            <p>Headache relief for backfill tasks</p>
        </div>
    </div>

    <div class="container">
        
        <!-- start form -->
        <form id="form" autocomplete="off">
            <!-- dag related controls -->
            <div class="row">
                <div class="form-inline">
                    <div class="form-group">
                        <label for="dag_name">Enter Dag Name:&nbsp;</label>
                        <input class="form-control mb-2 mr-sm-2" type="text" name="dag_name" id="dag_name" required="true">
                    </div>

                    <div class="form-group" style="position: relative;">
                        <label for="start_date">Enter Start Date:&nbsp;</label>
                        <input type="text" name="start_date" class="form-control datetimepicker-input mb-2 mr-sm-2" id="start_date" data-toggle="datetimepicker" data-target="#start_date" required="true"/>
                    </div>

                    <div class="form-group" style="position: relative;">
                        <label for="end_date">Enter End Date:&nbsp;</label>
                        <input type="text" name="end_date" class="form-control datetimepicker-input mb-2 mr-sm-2" id="end_date" data-toggle="datetimepicker" data-target="#end_date" required="true"/>
                    </div>  
                </div>
            </div>

            <!-- dag control options-->
            <div class="row custom-control custom-switch">
                <input type="checkbox" name="backfill" class="custom-control-input mb-2 mr-sm-2" id="backfill" value="yes" checked="true">
                <label class="custom-control-label" for="backfill">
                    Run backfill <span class="info-icon" data-toggle="tooltip" title="This will run backfill for the given DAG" data-placement="right">&#9432;</span>
                </label>
            </div>

            <div class="row custom-control custom-switch">
                <input type="checkbox" name="clear_prev" class="custom-control-input mb-2 mr-sm-2" id="clear_prev" value="yes">
                <label class="custom-control-label" for="clear_prev">
                    Clear Previous Runs(if any) <span class="info-icon" data-toggle="tooltip" title="If DAG got failed in interval you specified, then it will be cleared first and then backfill will run" data-placement="right">&#9432;</span>
                </label>
            </div>

            <div class="row custom-control custom-switch">
                <input type="checkbox" name="background" class="custom-control-input mb-2 mr-sm-2" id="background" value="yes">
                <label class="custom-control-label" for="background">
                    Run in background <span class="info-icon" data-toggle="tooltip" title="Running in background will use 'screen', a UNIX utility that will run this backfill in seperate terminal session. However you would also get a 'screen' id where your process is running" data-placement="right">&#9432;</span>
                </label>
            </div>

            <div class="row">
                <input id="submit" type="submit" class="btn btn-primary mb-2 mr-sm-2" value="Start">
                <input type="reset" class="btn btn-light mb-2 mr-sm-2" value="Clear">
            </div>
        </form>

        <!-- showing backfill status -->
        <div class="row" id="backfill_status">

        </div>

        <div class="row">
            <div class="col-md-12">

                <!-- nav tabs-->
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#console_output">Realtime Console Output <span class="info-icon" data-toggle="tooltip" title="Newest logs displayed first" data-placement="top">&#9432;</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" id="history_load" href="#history">History</a>
                    </li>

                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div id="console_output" class="container tab-pane active"><br>
                        <div id="output">
                            <p>No backfill running</p>
                        </div>
                    </div>
                    <div id="history" class="container tab-pane fade"><br>
                        <p>No data</p>
                    </div>
                  </div>

            </div>
        </tr>
</body>
</html>